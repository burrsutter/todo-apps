# Node.js 

RESTful APIs in the world of Node.js might be [Express](https://expressjs.com/en/starter/generator.html) but [Fastify](https://www.fastify.io/) and [Next.js](https://nextjs.org/docs/getting-started) seem to have the mometum these days


## Node+Fastify


[Node Version Manager - nvm](https://github.com/nvm-sh/nvm#installing-and-updating)

```
nvm --version
0.39.1

nvm install --lts

nvm use --lts

node --version
v16.14.2

npm --version
8.5.0

npx --version
8.5.0
```

Get the [fastify CLI](https://www.fastify.io/)

```
npm install --global fastify-cli
```

Generate intial project

```
fastify generate ntodo
```

```
cd ntodo
npm install
```

```
code .
```

![Node Fastify](images/node-fastify-1.png)

This following allows for edit-save-refresh (dynamic reloading)

```
npm run dev
```

In another terminal, verify that Node+Fastify are ready to go

```
curl localhost:3000
{"root":true}
```

```
curl localhost:3000/example
this is an example
```

![Node Fastify Dev Env](images/node-fastify-2.png)

Change routes/example/index.js

```
module.exports = async function (fastify, opts) {
  fastify.get('/', async function (request, reply) {
    return 'Burr Wuz Here'
  })
}
```

```
curl localhost:3000/example
Burr Wuz Here
```

## Postgres

Let's get a working postgres, spin one up in a 2nd terminal

```
docker run --name postgres --rm -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e PGDATA=/var/lib/postgresql/data/pgdata -v /tmp:/var/lib/postgresql/data -p 5432:5432 -it postgres:14.2-alpine
```

Spin up a psql client in a 3rd terminal

```
docker exec -it postgres /bin/bash
```

Connect to the postgres server

```
psql --username postgres
```

List databases

```
\l
```

```
                                 List of databases
   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-----------+----------+----------+------------+------------+-----------------------
 postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres
(3 rows)
```


## Prisma

Add a postgres and prisma


```
npm install pg
npm install prisma 
npx prisma init
```

The output from `prisma init`

```
Next steps:
1. Set the DATABASE_URL in the .env file to point to your existing database. If your database has no tables yet, read https://pris.ly/d/getting-started
2. Set the provider of the datasource block in schema.prisma to match your database: postgresql, mysql, sqlite, sqlserver or mongodb.
3. Run prisma db pull to turn your database schema into a Prisma schema.
4. Run prisma generate to generate the Prisma Client. You can then start querying your database.
```

Open the .env file (generated by npx prisma init) and update the `DATABASE_URL`


```
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/todo?schema=public"
```

Open the prisma/schema.prisma file (generated by npx prisma init) and double check its `provider`

```
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

Add the schema to schema.prisma

```
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Todo {
  id        Int       @id @default(autoincrement())
  completed Boolean   @default(false)
  ordering  Int       @default(autoincrement())
  title     String?
}

```

Generate the schema and update the postgres database

```
npx prisma migrate dev --name init
```

Output 

```
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "todo", schema "public" at "localhost:5432"

PostgreSQL database todo created at localhost:5432

Applying migration `20220424154706_init`

The following migration(s) have been created and applied from new schema changes:

migrations/
  └─ 20220424154706_init/
    └─ migration.sql

Your database is now in sync with your schema.
```

![Prisma](images/prisma-1.png)

In your psql client terminal

```
\l
```

to see the newly added *todo* database


## CRUD Code

Create directory called "api" under routes

Create a file called index.js

Add the some logic

```
'use strict'

const { PrismaClient } = require('@prisma/client')

const prisma = new PrismaClient()

module.exports = async function (fastify, opts) {
  fastify.get('/', async function (request, reply) {
    const todos = await prisma.todo.findMany({
    })
    reply.send(todos)
  })

  fastify.post('/', async function (request, reply) {
    const { title, completed } = request.body
    console.log ("title:" + title);
    console.log ("completed: " + completed);

    const result = await prisma.todo.create({
      data: {
        title,
        completed,
      },
    })
    reply.send(result)
  })

}

```

Test a POST

```
curl -X 'POST' \
  'localhost:3000/api' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "id": 0,
  "title": "Do a thing",
  "completed": false
}'
```

Test a GET

```
curl localhost:3000/api
[{"id":1,"completed":false,"ordering":1,"title":"Do a thing"}]
```

Test another POST

```
curl -X 'POST' \
  'localhost:3000/api' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "id": 0,
  "title": "Do another thing again",
  "completed": false
}'
```

Test another GET

```
curl localhost:3000/api
[{"id":1,"completed":false,"ordering":1,"title":"Do a thing"},{"id":2,"completed":false,"ordering":2,"title":"Do another thing"}]
```

Add the Delete handling code

```
  fastify.delete('/:id', async function (request, reply) {
      const { id } = request.params
      console.log("deleting: " + id)
    
      const todo = await prisma.todo.delete({
        where: {
          id: Number(id),
        },
      })
      reply.send(todo)

  })
```

Test a DELETE

```
curl -X 'DELETE' \
  'http://localhost:3000/api/2' \
  -H 'accept: */*'
```

Add the Update handling code

```
  // Update a todo
  fastify.put('/:id', async function (request, reply) {
    const { id } = request.params
    console.log("update for:" + id)
    console.log("request.body:" + request.body.title)
    
    
    try {
        const updatedTodo = await prisma.todo.update({
            where: { id: Number(id) },
            data: { 
                completed: request.body.completed,
                ordering: request.body.ordering,
                title: request.body.title
             },
          })
          reply.send(updatedTodo)
    } catch (error) {
        res.send({ error: `Todo with ID ${id} does not exist in the database` })
    } // try
  }) // put
```

```
curl -X 'PUT' \
  'http://localhost:3000/api/1' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "id": 0,
  "title": "new Task",
  "completed": false,
  "ordering": 2
}'
```

## OpenShift

![Add](images/fastify-openshift-0.png)

![Postgres 2](images/postgres-2.png)

![Postgres 3](images/postgres-3.png)

![Postgres 4](images/postgres-4.png)

Answer some questions

- PostgreSQL Connection Username: todo

- PostgreSQL Connection Password: todo

- PostgreSQL Database Name: todo

and click **Create**

![Postgres 5](images/postgres-5.png)

Adding the schema manually (not sure how to do this with Prisma)

![Postgres](images/voila-4b.png)

Click on pod identifier/name

![Pod details](images/voila-5.png)

Click on Terminal and type `psql`

![psql](images/voila-6.png)


```
CREATE TABLE "Todo" (
    "id" SERIAL NOT NULL,
    "completed" BOOLEAN NOT NULL DEFAULT false,
    "ordering" SERIAL NOT NULL,
    "title" TEXT,

    CONSTRAINT "Todo_pkey" PRIMARY KEY ("id")
);
```

Add - Import from Git

![Import from Git 1](images/fastify-openshift-1.png)

Advanced Options and context dir since I am using a sub-directory off the main root of the repo

![Import from Git 2](images/fastify-openshift-2.png)

Scroll down

Change port to 3000

click Deployment

![Deployment](images/fastify-openshift-3.png)


Add an environment variable

```
DATABASE_URL
```

Overriding user, password and server from your localhost dev env

```
postgresql://todo:todo@postgressql:5432/todo?schema=public
```

![env var](images/fastify-openshift-4.png)

Looking for blue rings, it can take a couple of minutes

![blue rings?](images/fastify-openshift-6.png)

Copy that URL from the Route

![URL](images/fastify-openshift-7.png)

Edit curl-tests.sh and overlay the localhost:3000/api with the URL

```
URL='https://todo-apps-burrsitis-dev.apps.sandbox.x8i5.p1.openshiftapps.com/api'

curl -X 'POST' \
  $URL \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "id": 0,
  "title": "Learn Node.js",
  "completed": false
}'

curl -X 'POST' \
  $URL \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "id": 0,
  "title": "Learn Fastify",
  "completed": false
}'

curl -X 'POST' \
  $URL \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "id": 0,
  "title": "Learn Prisma",
  "completed": false
}'

curl -X 'POST' \
  $URL \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "id": 0,
  "title": "Happy Dance",
  "completed": false
}'

```




## Supporting blogs/articles/docs

https://geshan.com.np/blog/2021/12/docker-postgres/

https://www.prisma.io/docs/getting-started/setup-prisma/start-from-scratch/relational-databases-typescript-postgres

## If you wish to re-generate schema


From your terminal,

```
rm -rf prisma/migrations
```

and in psql

```
drop database todo;
```
